<script lang="ts">
import { onMount } from 'svelte';
import { history } from '$lib/stores/historyStore';
import { loadHistory, useFromHistory, removeFromHistory, truncate, formatDate, clearAllHistory } from '$lib/api/clipboard';
import { get } from 'svelte/store';
import { listen } from '@tauri-apps/api/event';

let selectedIndex = -1;
let historyContainer: HTMLElement | null = null;
let unlisten: any;

function scrollToSelected() {
    if (historyContainer && selectedIndex >= 0) {
        const selectedItem = historyContainer.querySelector(`[data-index="${selectedIndex}"]`) as HTMLElement;
        if (selectedItem) selectedItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

async function loadEntryContent(entry) {
    if (!entry.content || entry.content.length === 0) {
        // fetch content from backend
        entry.content = await window.__TAURI__.invoke('get_clipboard_entry_content', { entryId: entry.id });
    }
    return entry.content;
}

function isImage(contentType: string) {
    return contentType.startsWith('image/');
}

function getImageDataUrl(content: number[], contentType: string) {
    const uint8Array = new Uint8Array(content);
    const base64 = btoa(String.fromCharCode(...uint8Array));
    return `data:${contentType};base64,${base64}`;
}

function getTextContent(content: number[]) {
    const uint8Array = new Uint8Array(content);
    return new TextDecoder('utf-8').decode(uint8Array);
}

onMount(() => {
    loadHistory();
    unlisten = listen('history-updated', () => loadHistory());
});
</script>